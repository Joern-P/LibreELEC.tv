From 04817f48e7acc37229e8c9c3e41bffcad0b25adf Mon Sep 17 00:00:00 2001
From: MrFixIt2001 <mrfixit2001@gmail.com>
Date: Tue, 16 Jun 2020 16:53:17 -0400
Subject: [PATCH] Enable vop PM before clocks

---
 drivers/gpu/drm/rockchip/rockchip_drm_vop.c | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/rockchip/rockchip_drm_vop.c b/drivers/gpu/drm/rockchip/rockchip_drm_vop.c
index e585c24ef4..e40ffb22a7 100644
--- a/drivers/gpu/drm/rockchip/rockchip_drm_vop.c
+++ b/drivers/gpu/drm/rockchip/rockchip_drm_vop.c
@@ -1338,10 +1338,16 @@ static void vop_power_enable(struct drm_crtc *crtc)
 	struct vop *vop = to_vop(crtc);
 	int ret, i;
 
+	ret = pm_runtime_get_sync(vop->dev);
+	if (ret < 0) {
+		dev_err(vop->dev, "failed to get pm runtime: %d\n", ret);
+		return;
+	}
+
 	ret = clk_prepare_enable(vop->hclk);
 	if (ret < 0) {
 		dev_err(vop->dev, "failed to enable hclk - %d\n", ret);
-		return;
+		goto err_put_pm_runtime;
 	}
 
 	ret = clk_prepare_enable(vop->dclk);
@@ -1356,12 +1362,6 @@ static void vop_power_enable(struct drm_crtc *crtc)
 		goto err_disable_dclk;
 	}
 
-	ret = pm_runtime_get_sync(vop->dev);
-	if (ret < 0) {
-		dev_err(vop->dev, "failed to get pm runtime: %d\n", ret);
-		return;
-	}
-
 	VOP_INTR_SET_TYPE(vop, clear, INTR_MASK, 1);
 	VOP_INTR_SET_TYPE(vop, enable, INTR_MASK, 0);
 
@@ -1389,6 +1389,8 @@ static void vop_power_enable(struct drm_crtc *crtc)
 	clk_disable_unprepare(vop->dclk);
 err_disable_hclk:
 	clk_disable_unprepare(vop->hclk);
+err_put_pm_runtime:
+	pm_runtime_put_sync(vop->dev);
 }
 
 static void vop_initial(struct drm_crtc *crtc)
@@ -2780,6 +2782,7 @@ static void vop_crtc_enable(struct drm_crtc *crtc)
 	vop->mode_update = vop_crtc_mode_update(crtc);
 	if (vop->mode_update)
 		vop_disable_all_planes(vop);
+
 	/*
 	 * restore the lut table.
 	 */

