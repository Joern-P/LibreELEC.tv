#!/bin/sh

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2009-2015 Stephan Raue (stephan@openelec.tv)
# Copyright (C) 2019-present Team LibreELEC (https://libreelec.tv)

SYS_CPUFREQ_GOV=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)

if [ "${SYS_CPUFREQ_GOV}" = "ondemand" ]; then
  for io_is_busy in $(find /sys/devices/system/cpu -name io_is_busy); do
    echo 1 > "${io_is_busy}"
  done
  for up_threshold in $(find /sys/devices/system/cpu -name up_threshold); do
    echo 50 > "${up_threshold}"
  done
  for sampling_rate in $(find /sys/devices/system/cpu -name sampling_rate); do
    echo 100000 > "${sampling_rate}"
  done
  for sampling_down_factor in $(find /sys/devices/system/cpu -name sampling_down_factor); do
    echo 50 > "${sampling_down_factor}"
  done
else
  echo "cpufreq: settings not found for current cpu governor." | systemd-cat -p info
fi

for i in $(awk -F':' '/gpu/{print $1}' </proc/interrupts | sed 's/\ //g'); do
	echo 2 >/proc/irq/$i/smp_affinity
done
for i in $(awk -F':' '/dw-mci/{print $1}' </proc/interrupts | sed 's/\ //g'); do
	echo 2 >/proc/irq/$i/smp_affinity
done
for i in $(awk -F":" "/ehci/ {print \$1}" </proc/interrupts | sed 's/\ //g'); do
	echo 2 >/proc/irq/$i/smp_affinity
done
for i in $(awk -F":" "/ohci/ {print \$1}" </proc/interrupts | sed 's/\ //g'); do
	echo 2 >/proc/irq/$i/smp_affinity
done
for i in $(awk -F":" "/xhci/ {print \$1}" </proc/interrupts | sed 's/\ //g'); do
	echo 4 >/proc/irq/$i/smp_affinity
done
echo 8 >/proc/irq/$(awk -F":" "/eth0/ {print \$1}" </proc/interrupts | sed 's/\ //g')/smp_affinity
echo 7 >/sys/class/net/eth0/queues/rx-0/rps_cpus
echo 32768 >/proc/sys/net/core/rps_sock_flow_entries
echo 32768 >/sys/class/net/eth0/queues/rx-0/rps_flow_cnt
for i in $(awk -F':' 'tolower($0) ~ /pcie/{print $1}' </proc/interrupts | sed 's/\ //g'); do
	echo 16 >/proc/irq/$i/smp_affinity
done
# set dmc memory governor to performance with default kernel
if [ -f /sys/bus/platform/drivers/rockchip-dmc/dmc/devfreq/dmc/governor ]; then
	echo performance > /sys/bus/platform/drivers/rockchip-dmc/dmc/devfreq/dmc/governor
fi
